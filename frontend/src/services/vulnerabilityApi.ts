import api from "./api";

export type Severity = "Critical" | "High" | "Medium" | "Low";
export type Status = "Open" | "Resolved";

export interface Vulnerability {
  id: string;
  severity: Severity;
  affectedSystem: string;
  status: Status;
  reportedDate: string;
  description: string;
  cveId: string;
  remediationSteps: string[];
  title: string;
}

export interface VulnerabilitySummary {
  total: number;
  critical: number;
  high: number;
  medium: number;
  low: number;
}

export async function fetchVulnerabilities(): Promise<Vulnerability[]> {
  try {
    const response = await api.get("/vulnerabilities");
    const data = response.data.data;

    return data.map((item: any) => ({
      id: item._id,
      severity: item.severity,
      affectedSystem: Array.isArray(item.affectedSystems)
        ? item.affectedSystems.join(", ")
        : item.affectedSystems,
      status: item.status,
      reportedDate: item.reportedDate,
      description: item.description,
      title: item.title,
      cveId: item.cveId,
      remediationSteps: [item.remediation], // Wrap single string in array
    }));
  } catch (error) {
    console.error("Error fetching vulnerabilities:", error);
    return [];
  }
}

export async function fetchSummary(): Promise<VulnerabilitySummary> {
  try {
    const vulnerabilities = await fetchVulnerabilities();

    return {
      total: vulnerabilities.length,
      critical: vulnerabilities.filter((v) => v.severity === "Critical").length,
      high: vulnerabilities.filter((v) => v.severity === "High").length,
      medium: vulnerabilities.filter((v) => v.severity === "Medium").length,
      low: vulnerabilities.filter((v) => v.severity === "Low").length,
    };
  } catch (error) {
    console.error("Error fetching summary:", error);
    return {
      total: 0,
      critical: 0,
      high: 0,
      medium: 0,
      low: 0,
    };
  }
}

